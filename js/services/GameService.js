import e,{validKeys as t}from"./LocalStorageService.js";import r from"../words.js";import s from"../helpRender.js";const i=3e3,n=3,o=5,a={ua:"Українська",en:"Англійська"};class l{_wordSize=3;_maxTries=5;_results=[];_quizWord=null;_userWords=[];_matrixContainerSelector=null;_keyboardContainerSelector=null;_currentWordIndex=0;_gameOver=!1;constructor(r,i,n=3,o=5){this._keyboardContainerSelector=i,this._matrixContainerSelector=r;const a=document.getElementById("modal-content"),l=document.getElementById("help-content");e.get(t.maxTries)?this._maxTries=e.get(t.maxTries):(e.set(t.maxTries,o),this._maxTries=o),e.get(t.wordSize)?this._wordSize=e.get(t.wordSize):(e.set(t.wordSize,n),this._wordSize=n),e.get(t.results)?this._results=e.get(t.results):e.set(t.results,[]),null==e.get(t.darkTheme)&&e.set(t.darkTheme,!1),this.initQuizWord(),a.innerHTML=s(this._maxTries,this._wordSize),l.innerHTML=s(this._maxTries,this._wordSize)}get wordSize(){return this._wordSize}initQuizWord(){const e=Array.from(r).filter(e=>e.length===this._wordSize),t=Math.round(Math.random()*e.length-1);this._quizWord=e[t]}createQuizMatrix(){const e=[],t=document.querySelector(this._matrixContainerSelector);for(let r=0;r<this._maxTries;r++)r<this._userWords.length?this._currentWordIndex>0&&r<this._currentWordIndex?e.push(this._quizRow(this._userWords[r],!0)):e.push(this._quizRow(this._userWords[r])):e.push(this._quizRow());t.innerHTML=e.join("\n")}createKeyboard(e=a.ua){const t=document.querySelector(this._keyboardContainerSelector),r=[["q","w","e","r","t","y","u","i","o","p","$backspace"],["a","s","d","f","g","h","j","k","l","$enter"],["z","x","c","v","b","n","m"]],s=[["й","ц","у","к","е","н","г","ш","щ","з","х","ї","ґ","$backspace"],["ф","і","в","а","п","р","о","л","д","ж","є","$enter"],["я","ч","с","м","и","т","ь","б","ю"]];switch(e){case a.ua:t.innerHTML=this._keyboardParser(s);break;case a.en:t.innerHTML=this._keyboardParser(r);break;default:return}Array.from(document.querySelectorAll(".key.letter")).forEach(e=>e.addEventListener("click",this._onLetterKeyClickHandler)),Array.from(document.querySelectorAll(".key.ctrl")).forEach(e=>e.addEventListener("click",this._onCtrlKeyClickHandler))}_quizRow(e=null,t=!1){let r="";if(null==e)for(let s=0;s<this._wordSize;s++)r+='<div class="letter"></div>\n';else if(t)for(let s=0;s<this._wordSize;s++)e[s]==this._quizWord[s]?r+=`<div class="letter right-place">${e[s]}</div>\n`:this._quizWord.includes(e[s])?r+=`<div class="letter wrong-place">${e[s]}</div>\n`:r+=`<div class="letter not-in-word">${e[s]}</div>\n`;else for(let s=0;s<this._wordSize;s++)null==e[s]?r+='<div class="letter"></div>\n':r+=`<div class="letter filled">${e[s]}</div>\n`;return`<div class="matrix-row">${r}</div>`}_onCtrlKeyClickHandler=e=>{if(this._results.filter(e=>new Date(e.time).toLocaleDateString()===(new Date).toLocaleDateString()).length>0)this._message("Продовжуйте завтра");else switch(e.currentTarget.innerText){case"enter":this._onEnterKlickHandler();break;case"backspace":this._onBackspaceKlickHandler()}};_onLetterKeyClickHandler=e=>{if(this._results.filter(e=>new Date(e.time).toLocaleDateString()===(new Date).toLocaleDateString()).length>0)return void this._message("Продовжуйте завтра");const t=e.currentTarget.innerText;this._gameOver?this._message("Продовжуйте завтра"):(null==this._userWords[this._currentWordIndex]&&this._userWords.length<=this._maxTries&&this._userWords.push(""),this._userWords[this._currentWordIndex].length<this._wordSize&&this._userWords.length<=this._maxTries&&(this._userWords[this._currentWordIndex]+=t,this.createQuizMatrix()))};_onEnterKlickHandler(){const e=this._userWords[this._currentWordIndex];if(this._gameOver)this._message("Продовжуйте завтра");else{if(this._currentWordIndex===this._maxTries-1)return this._message("Продовжуйте завтра, ви не вгадали"),void this._saveResult(!1);if(e&&e.length!==this._wordSize)this._message("Не достатньо букв");else if(r.includes(e)){if(this._userWords.filter(t=>t===e).length>1)return void this._message("Слово дублюється");this._currentWordIndex++,this.createQuizMatrix(),this._currentWordIndex<=this._maxTries&&e===this._quizWord&&(this._message("Перемога!"),this._saveResult(!0))}else e?this._message("Слова немає в словнику"):this._message("Введіть слово")}}_onBackspaceKlickHandler(){const e=this._userWords[this._currentWordIndex];e&&(this._userWords[this._currentWordIndex]=e.substr(0,e.length-1),this.createQuizMatrix())}_keyboardParser(e){let t=[];for(let r=0;r<e.length;r++){const s=e[r].map(e=>{if(e.startsWith("$")){const t=e.substr(1);return`<div class="key ctrl ${t}">\n              ${t}\n            </div>`}return`<div class="key letter">\n              ${e}\n            </div>`}).join("\n");t.push(`<div class="keys-row">${s}</div>`)}return t.join("\n")}_message(e){const t=document.getElementById("message-box");document.getElementById("message").innerText=e,t.style.display="flex",setTimeout(()=>{t.style.display="none"},3e3)}_saveResult(r){const s=new Date,i=new Date(s.getTime()-6048e5);let n=e.get(t.results);const o={time:(new Date).getTime(),tries:this._currentWordIndex,wordSize:this._wordSize,win:r};n.push(o),n=n.filter(e=>e.time>=i&&e.time<=s),e.set(t.results,n),this._gameOver=!0}}export default l;